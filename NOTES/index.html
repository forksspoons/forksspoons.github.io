// --- SUPABASE SETUP ---
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'

const SUPABASE_URL = 'https://cxuteylfjxbbwyvlkcew.supabase.co'; 
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN4dXRleWxmanhiYnd5dmxrY2V3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2OTAzMDIsImV4cCI6MjA3MTI2NjMwMn0.cyhbaptKZBWNzwv-NFsuVFMqr2Oo54mT9EX7c-F0S5w';

let supabaseClient;
try {
    supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
} catch (error) {
    console.error('Failed to initialize Supabase client:', error);
    showError('Failed to initialize database connection.');
}

// --- SECURITY DETERRENT (Optional - Remove if not needed) ---
document.addEventListener('contextmenu', event => event.preventDefault());
document.onkeydown = function (e) {
    if (e.keyCode == 123) return false; // F12
    if (e.ctrlKey && e.shiftKey && (e.keyCode == 'I'.charCodeAt(0) || e.keyCode == 'C'.charCodeAt(0) || e.keyCode == 'J'.charCodeAt(0))) return false;
    if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) return false;
};

// Global variables
let allNotes = [];
let currentView = 'subjects'; // Track current view for navigation

/**
 * Initialize the application when DOM loads
 */
document.addEventListener('DOMContentLoaded', initializeApp);

async function initializeApp() {
    const loadingState = document.getElementById('loading-state');

    if (!supabaseClient) {
        showError('Database connection failed. Please refresh the page.');
        return;
    }

    try {
        // Fetch all notes from the 'notes' table with proper ordering
        const { data, error } = await supabaseClient
            .from('notes')
            .select('*')
            .order('subject', { ascending: true })
            .order('level', { ascending: true })
            .order('title', { ascending: true });

        if (error) {
            console.error('Error fetching notes:', error);
            showError('Failed to load resources. Please try again later.');
            return;
        }

        if (!data || data.length === 0) {
            showError('No resources found.');
            return;
        }

        allNotes = data;
        showSubjectSelection();
    } catch (error) {
        console.error('Unexpected error:', error);
        showError('An unexpected error occurred. Please refresh the page.');
    }
}

/**
 * Display error message with retry option
 * @param {string} message - Error message to display
 */
function showError(message) {
    const notesContainer = document.getElementById('notes-container');
    const loadingState = document.getElementById('loading-state');

    if (loadingState) {
        loadingState.style.display = 'none';
    }

    notesContainer.innerHTML = `
        <div class="error-state">
            <i data-lucide="alert-circle" class="w-8 h-8 mx-auto mb-2"></i>
            <p class="font-semibold">${message}</p>
            <button onclick="location.reload()" class="mt-3 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                Try Again
            </button>
        </div>
    `;
    lucide.createIcons();
}

/**
 * Render the main subject selection screen
 */
function showSubjectSelection() {
    currentView = 'subjects';
    const notesContainer = document.getElementById('notes-container');
    const loadingState = document.getElementById('loading-state');

    if (loadingState) {
        loadingState.style.display = 'none';
    }

    // Get unique subjects and sort them
    const subjects = [...new Set(allNotes.map(note => note.subject))].sort();

    let html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">';

    subjects.forEach(subject => {
        const subjectNotes = allNotes.filter(n => n.subject === subject);
        const subjectCode = subjectNotes[0]?.caie_code;
        const noteCount = subjectNotes.length;

        // Show CAIE code only if it exists and is not -1
        const codeHtml = subjectCode && subjectCode !== -1 ? 
            `<p class="text-sm text-gray-400">CAIE Code: ${subjectCode}</p>` : '';

        html += `
            <div class="subject-card bg-gray-800 p-6 rounded-2xl border border-gray-700 cursor-pointer" data-subject="${subject}">
                <div class="flex items-center justify-between">
                    <div class="flex items-center flex-1">
                        <i data-lucide="folder" class="w-10 h-10 mr-4 text-cyan-400 flex-shrink-0"></i>
                        <div class="min-w-0">
                            <h2 class="text-xl font-bold truncate">${subject}</h2>
                            ${codeHtml}
                            <p class="text-xs text-gray-500 mt-1">${noteCount} resource${noteCount !== 1 ? 's' : ''}</p>
                        </div>
                    </div>
                    <i data-lucide="chevron-right" class="w-5 h-5 text-gray-500 flex-shrink-0"></i>
                </div>
            </div>
        `;
    });

    html += '</div>';

    notesContainer.innerHTML = html;

    // Add event listeners to subject cards (better than inline onclick)
    document.querySelectorAll('.subject-card').forEach(card => {
        card.addEventListener('click', (e) => {
            const subject = e.currentTarget.getAttribute('data-subject');
            if (subject) {
                showSubjectDetail(subject);
            }
        });
    });

    lucide.createIcons();
}

/**
 * Render detailed view for a specific subject
 * @param {string} subjectName - Name of the subject to display
 */
function showSubjectDetail(subjectName) {
    currentView = 'detail';
    const notesContainer = document.getElementById('notes-container');
    const subjectNotes = allNotes.filter(note => note.subject === subjectName);

    // Group notes by level for better organization
    const asLevelNotes = subjectNotes.filter(n => n.level === 'AS');
    const a2LevelNotes = subjectNotes.filter(n => n.level === 'A2');
    const generalNotes = subjectNotes.filter(n => n.level === '-1' || n.level === 'General');

    let html = `
        <div class="space-y-8">
            <div class="flex items-center justify-between">
                <button id="back-button" class="flex items-center text-gray-400 hover:text-white transition-colors group">
                    <i data-lucide="arrow-left" class="w-5 h-5 mr-2 group-hover:-translate-x-1 transition-transform"></i>
                    Back to Subjects
                </button>
                <div class="text-sm text-gray-500">
                    ${subjectNotes.length} resource${subjectNotes.length !== 1 ? 's' : ''}
                </div>
            </div>
            <h2 class="text-3xl md:text-4xl font-bold text-center">${subjectName}</h2>
    `;

    // Helper function to create level section
    function createLevelSection(notes, title, colorClass) {
        if (notes.length === 0) return '';

        return `
            <div class="bg-gray-800/50 p-6 rounded-xl border border-gray-700">
                <h3 class="text-2xl font-bold mb-4 ${colorClass} flex items-center">
                    <i data-lucide="book-open" class="w-6 h-6 mr-2"></i>
                    ${title}
                    <span class="ml-2 text-sm font-normal text-gray-500">(${notes.length})</span>
                </h3>
                <ul class="space-y-2">
                    ${notes.map(note => generateNoteItemHTML(note)).join('')}
                </ul>
            </div>
        `;
    }

    // Add sections for each level if they have content
    html += createLevelSection(asLevelNotes, 'AS Level', 'text-indigo-300');
    html += createLevelSection(a2LevelNotes, 'A2 Level', 'text-purple-300');
    html += createLevelSection(generalNotes, 'General Resources', 'text-gray-300');

    html += '</div>';

    notesContainer.innerHTML = html;

    // Add back button event listener
    document.getElementById('back-button').addEventListener('click', showSubjectSelection);

    lucide.createIcons();
}

/**
 * Generate HTML for a single note item
 * @param {Object} note - Note object from database
 * @returns {string} HTML string for the note item
 */
function generateNoteItemHTML(note) {
    const icon = note.type === 'file' ? 'file-text' : 'link';
    const isExternal = note.url && (note.url.startsWith('http') || note.url.startsWith('https'));

    return `
        <li>
            <a href="${note.url || '#'}" 
               ${isExternal ? 'target="_blank" rel="noopener noreferrer"' : ''}
               class="note-item flex items-center p-3 bg-gray-900/70 rounded-lg hover:bg-gray-700 transition-all duration-200 cursor-pointer group border border-transparent hover:border-gray-600">
                <i data-lucide="${icon}" class="note-icon w-5 h-5 mr-3 text-gray-400 transition-colors group-hover:text-cyan-400 flex-shrink-0"></i>
                <span class="flex-1 truncate group-hover:text-white transition-colors">${note.title || 'Untitled'}</span>
                ${isExternal ? '<i data-lucide="external-link" class="w-4 h-4 text-gray-500 group-hover:text-gray-300 transition-colors flex-shrink-0"></i>' : ''}
            </a>
        </li>
    `;
}

// Browser navigation handling
window.addEventListener('popstate', (event) => {
    if (currentView === 'detail') {
        showSubjectSelection();
    }
});

// Keyboard navigation support
document.addEventListener('keydown', (event) => {
    if (event.key === 'Escape' && currentView === 'detail') {
        showSubjectSelection();
    }
});

// Export functions for potential external use
export { showSubjectSelection, showSubjectDetail };
